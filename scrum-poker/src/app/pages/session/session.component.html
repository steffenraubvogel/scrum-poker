<ng-container *ngIf="session?.state; else loadingTemplate">
  <h1>{{ session!.state!.name }}</h1>

  <div class="row g-3">
    <div class="col-12 col-sm-6">
      <div class="sp-card sp-card-participants">
        <h2>Participants</h2>
        <p>
          Leader:
          <ng-container
            *ngTemplateOutlet="playerTemplate; context: { player: playersByRole('leader').length === 0 ? { name: '-' } : playersByRole('leader')[0] }"
          >
          </ng-container>
        </p>

        <div *ngIf="playersByRole('guesser').length > 0">
          <p>Guessers:</p>
          <ul>
            <ng-container *ngFor="let player of playersByRole('guesser')">
              <li>
                <ng-container *ngTemplateOutlet="playerTemplate; context: { player }"></ng-container>
              </li>
            </ng-container>
          </ul>
        </div>

        <div *ngIf="playersByRole('observer').length > 0">
          <p>Observer:</p>
          <ul>
            <ng-container *ngFor="let player of playersByRole('observer')">
              <li><ng-container *ngTemplateOutlet="playerTemplate; context: { player }"></ng-container></li>
            </ng-container>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6" *ngIf="settingsService.settings.active === 'created'">
      <div class="sp-card sp-card-leader-actions">
        <h2>Leader Actions</h2>
        <div class="row g-3">
          <div class="col-auto">
            <button (click)="copyJoinLink()" class="btn btn-primary">Copy Join Link</button>
          </div>
          <div class="col-auto">
            <button (click)="session!.reveal()" class="btn btn-primary">Reveal Votes</button>
          </div>
          <div class="col-auto">
            <button (click)="session!.reset()" class="btn btn-warning">Reset Votes</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6" *ngIf="settingsService.settings.active === 'joined' && settingsService.settings.join?.role === 'guesser'">
      <div class="sp-card sp-card-guesser-actions">
        <h2>Your Vote</h2>
        <p>Please choose your guess for the currently discussed story or topic:</p>
        <form>
          <div class="form-check" *ngFor="let guess of guessOptions; index as i">
            <input class="form-check-input" type="radio" [id]="'guessOption' + i" [value]="guess.value" [formControl]="playersGuess" />
            <label class="form-check-label" [for]="'guessOption' + i">
              {{ guess.label }}
            </label>
          </div>
        </form>
      </div>
    </div>

    <div class="col-12 col-sm-6" *ngIf="settingsService.settings.active === 'joined' && settingsService.settings.join?.role === 'observer'">
      <div class="sp-card sp-card-observer-actions">
        <h2>Oberserver Actions</h2>
        <p>Sit back and relax.</p>
      </div>
    </div>
  </div>

  <div class="mt-4 sp-card">
    <h2>Result</h2>
    <ng-container *ngIf="session!.state!.state === 'revealed'; else notYetRevealedResultTemplate">
      <div class="row g-3">
        <div class="col-12 col-sm-6">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Guess</th>
                <th scope="col">Vote Count</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of guessCountTable()">
                <th scope="row">{{ row.guess }}</th>
                <td>{{ row.count }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-12 col-sm-6 sp-chart-votes-container">
          <ngx-charts-bar-vertical
            [results]="chartData"
            [xAxis]="true"
            [yAxis]="true"
            xAxisLabel="Guesses"
            [showXAxisLabel]="true"
            yAxisLabel="Vote Counts"
            [showYAxisLabel]="true"
            [yAxisTickFormatting]="chartYAxisFormat"
            [yScaleMax]="playersByRole('guesser').length"
          >
            <ng-template #tooltipTemplate let-model="model">
              {{ formatVoters(model) }}
            </ng-template>
          </ngx-charts-bar-vertical>
        </div>
      </div>
    </ng-container>
    <ng-template #notYetRevealedResultTemplate>
      <p>
        The result is not yet revealed. This will be done when all guessers have voted or the leader reveals the result intentionally. Please be
        patient.
      </p>
    </ng-template>
  </div>
</ng-container>

<ng-template #loadingTemplate>
  <div class="d-flex justify-content-center sp-loading">
    <div class="sp-loading-dot"></div>
    <div class="sp-loading-dot"></div>
    <div class="sp-loading-dot"></div>
    <div class="sp-loading-dot"></div>
  </div>
</ng-template>

<ng-template #playerTemplate let-player="player">
  <span [ngClass]="{ 'sp-player-disconnected': player.status === 'disconnected', 'sp-player-own': isOwnPlayer(player) }">{{ player.name }}</span>
  &nbsp;
  <span>
    <ng-container *ngIf="player.status === 'disconnected'; else connectedTemplate">
      <i class="bi bi-plug"></i>
      <i class="bi bi-exclamation-triangle text-danger-emphasis"></i>
    </ng-container>
    <ng-template #connectedTemplate>
      <ng-container *ngIf="player.type === 'guesser'">
        <span *ngIf="session!.state!.state === 'revealed'">
          {{ player.guess === -1 ? "?" : player.guess === null ? "-" : player.guess }}
        </span>
        <span *ngIf="session!.state!.state === 'guessing'">
          <i class="bi bi-chat-dots" *ngIf="player.guess === null"></i>
          <i class="bi bi-check2-circle" *ngIf="player.guess !== null"></i>
        </span>
      </ng-container>
    </ng-template>
  </span>
</ng-template>
