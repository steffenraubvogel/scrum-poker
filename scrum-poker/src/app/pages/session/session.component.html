<ng-container *ngIf="session?.state">
  <h1>{{ session!.state!.name }}</h1>

  <div class="row g-3">
    <div class="col-12 col-sm-6">
      <div class="sp-card sp-card-participants">
        <h2>Participants</h2>
        <div *ngIf="playersByRole('leader').length > 0" class="sp-participants-section">
          <div class="small">Moderator:</div>
          <ul class="list-group list-group-flush">
            <ng-container *ngFor="let player of playersByRole('leader'); trackBy: trackByPlayerName">
              <li class="list-group-item">
                <ng-container *ngTemplateOutlet="playerTemplate; context: { player }"></ng-container>
              </li>
            </ng-container>
          </ul>
        </div>

        <div *ngIf="playersByRole('guesser').length > 0" class="mt-3 sp-participants-section">
          <div class="small">Guessers:</div>
          <ul class="list-group list-group-flush">
            <ng-container *ngFor="let player of playersByRole('guesser'); trackBy: trackByPlayerName">
              <li class="list-group-item">
                <ng-container *ngTemplateOutlet="playerTemplate; context: { player }"></ng-container>
              </li>
            </ng-container>
          </ul>
        </div>

        <div *ngIf="playersByRole('observer').length > 0" class="mt-3 sp-participants-section">
          <div class="small">Observers:</div>
          <ul class="list-group list-group-flush">
            <ng-container *ngFor="let player of playersByRole('observer'); trackBy: trackByPlayerName">
              <li class="list-group-item">
                <ng-container *ngTemplateOutlet="playerTemplate; context: { player }"></ng-container>
              </li>
            </ng-container>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6" *ngIf="settingsService.settings.active === 'created'">
      <div class="sp-card sp-card-leader-actions">
        <h2>Moderator Actions</h2>
        <div class="row g-3">
          <div class="col-auto">
            <button (click)="copyJoinLink()" class="btn btn-primary">
              <span class="sp-copy-button-icon" [ngClass]="{ 'sp-success-button-icon': copied }"
                ><i class="bi bi-share"></i><i class="bi bi-clipboard-check sp-icon-success"></i
              ></span>
              Copy Join Link
            </button>
          </div>
          <div class="col-auto">
            <button (click)="session!.reveal()" class="btn btn-primary" [disabled]="cannotReveal()"><i class="bi bi-eye"></i> Reveal Votes</button>
          </div>
          <div class="col-auto">
            <button (click)="session!.reset()" class="btn btn-warning"><i class="bi bi-arrow-clockwise"></i> Reset Votes</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6" *ngIf="settingsService.settings.active === 'joined' && settingsService.settings.join?.role === 'guesser'">
      <div class="sp-card sp-card-guesser-actions">
        <h2>Your Vote</h2>
        <p>Please choose your guess for the currently discussed story or topic:</p>
        <div class="sp-guess-actions-container my-4 mx-auto">
          <div class="sp-aspect-ratio-1-to-1">
            <div class="sp-guess-actions-grid">
              <button
                *ngFor="let guess of guessOptions; index as i"
                (click)="vote(guess.value)"
                class="btn btn-guess sp-guess-action"
                [ngClass]="{ active: playersGuess === guess.value }"
              >
                {{ guess.label }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6" *ngIf="settingsService.settings.active === 'joined' && settingsService.settings.join?.role === 'observer'">
      <div class="sp-card sp-card-observer-actions">
        <h2>Oberserver Actions</h2>
        <p>Sit back and relax.</p>
      </div>
    </div>
  </div>

  <div class="mt-4 sp-card">
    <h2>Result</h2>
    <ng-container *ngIf="session!.state!.state === 'revealed'; else notYetRevealedResultTemplate">
      <p *ngIf="!isConsesus()">The average guess is âŒ€ {{ getAverageGuess() }}.</p>
      <p *ngIf="isConsesus()">Woohoo, consensus! <i class="bi bi-emoji-smile"></i></p>
      <div class="row g-3">
        <div class="col-12 col-sm-6">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Guess</th>
                <th scope="col">Vote Count</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of guessCountTable()">
                <th scope="row">{{ row.guess }}</th>
                <td>{{ row.count }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-12 col-sm-6 sp-chart-votes-container">
          <app-bar-chart
            xAxisLabel="Guesses"
            yAxisLabel="Vote Counts"
            [yAxisMaxValue]="playersByRole('guesser').length"
            [data]="chartData"
          ></app-bar-chart>
        </div>
      </div>
    </ng-container>
    <ng-template #notYetRevealedResultTemplate>
      <p>
        The result is not yet revealed. This will be done when all guessers have voted or the moderator reveals the result intentionally. Please be
        patient.
      </p>
    </ng-template>
  </div>
</ng-container>

<ng-container *ngIf="session?.connection$ | async as connection">
  <app-loading [show]="connection.state === 'connecting'"> </app-loading>
</ng-container>

<ng-template #playerTemplate let-player="player">
  <span
    [ngClass]="{
      'sp-player-disconnected': player.status === 'disconnected',
      'sp-player-left': player.status === 'left',
      'sp-player-own': isOwnPlayer(player)
    }"
    >{{ player.name }}</span
  >
  &nbsp;
  <app-stack [activeChild]="mapPlayerAndSessionStatusToStackChild(player)">
    <span *stackChild title="Participant disconnected">
      <i class="bi bi-plug"></i>
      <i class="bi bi-exclamation-triangle text-danger-emphasis"></i>
    </span>
    <i *stackChild class="bi bi-x-octagon" title="Participant left"></i>
    <span *stackChild></span>
    <span
      *stackChild
      class="badge rounded-pill text-bg-light"
      [title]="player.guess === -1 ? 'Chose to abstain from vote' : player.guess === null ? 'Did not choose anything' : 'Voted for ' + player.guess"
    >
      {{ player.guess === -1 ? "?" : player.guess === null ? "-" : player.guess }}
    </span>
    <i *stackChild class="bi bi-three-dots" title="Did not make a selection so far"></i>
    <i *stackChild class="bi bi-check2-circle sp-status-guessed" title="Has made a selection"></i>
  </app-stack>
</ng-template>
